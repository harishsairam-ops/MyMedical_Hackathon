<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PetScan Pro: Local Animal Health Risk & Photo Analysis</title>
    

<script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Custom styles for appearance */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e0e7ff 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column; 
            padding-top: 4.5rem; /* Space for fixed navbar */
        }
        .container-card {
            box-shadow: 0 10px 30px rgba(27, 31, 46, 0.1);
            transition: opacity 0.5s ease, transform 0.5s ease;
            transform: translateY(0);
        }
        .input-box {
            transition: all 0.3s ease-in-out;
            border-color: #d1d5db; 
        }
        .input-box:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
        }
        .btn-check, .btn-primary {
            transition: background-color 0.3s, transform 0.1s, box-shadow 0.3s;
        }
        .btn-check:hover, .btn-primary:hover {
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }
        .btn-check:active, .btn-primary:active {
            transform: scale(0.98);
        }
        /* Style for the select arrow */
        select {
          -webkit-appearance: none;
          -moz-appearance: none;
          appearance: none;
          background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="%234B5563" d="M7 10l5 5 5-5z"/></svg>');
          background-repeat: no-repeat;
          background-position: right 10px center;
          padding-right: 30px;
        }

        /* --- Custom Animations for Home Page "WOW" factor --- */
        @keyframes pulse-shadow {
            0% { box-shadow: 0 10px 20px rgba(66, 153, 225, 0.3); }
            50% { box-shadow: 0 15px 30px rgba(66, 153, 225, 0.5); }
            100% { box-shadow: 0 10px 20px rgba(66, 153, 225, 0.3); }
        }
        
        .hero-card {
            animation: pulse-shadow 4s ease-in-out infinite alternate;
        }

        /* Loading Spinner Animation */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Active Navbar Link Styling */
        .nav-link.active {
            color: #2563eb !important; /* Blue-600 */
            font-weight: 700;
            background-color: #eff6ff; /* Blue-50 */
            border-radius: 0.375rem;
        }
        
        /* Collapsible Styling */
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
            padding-top: 0;
        }
        .collapsible-content.open {
            max-height: 1000px; /* Needs to be larger than content height */
            padding-top: 0.75rem; /* pt-3 */
        }
        
        /* File Upload Styles */
        #imagePreviewContainer {
            min-height: 200px;
            border: 2px dashed #ccc;
            background-color: #f9f9f9;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 0.75rem;
        }
        #imagePreview {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
    </style>
</head>
<body class="p-0">

    

<nav class="fixed top-0 left-0 w-full bg-white shadow-xl z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                

<div class="flex-shrink-0">
                    <button onclick="showPage('home-page')" class="text-2xl font-extrabold text-blue-700 hover:text-blue-500 transition-colors tracking-wide">
                        PetScan Pro
                    </button>
                </div>
                

<div class="flex space-x-1 sm:space-x-2">
                    <button id="nav-home-page" onclick="showPage('home-page')" class="nav-link text-gray-600 hover:text-blue-600 font-medium px-3 py-2 rounded-md transition-colors">Home</button>
                    <button id="nav-scanner-page" onclick="showPage('scanner-page')" class="nav-link text-gray-600 hover:text-blue-600 font-medium px-3 py-2 rounded-md transition-colors">Scanner</button>
                    <button id="nav-upload-page" onclick="showPage('upload-page')" class="nav-link text-gray-600 hover:text-blue-600 font-medium px-3 py-2 rounded-md transition-colors">File Upload</button>
                    <button id="nav-about-us-page" onclick="showPage('about-us-page')" class="nav-link text-gray-600 hover:text-blue-600 font-medium px-3 py-2 rounded-md transition-colors hidden sm:block">About Us</button>
                </div>
            </div>
        </div>
    </nav>
    
    

<main class="flex-grow p-4 flex justify-center w-full">
        <div class="w-full max-w-xl">

            

<div id="home-page" class="container-card w-full bg-white p-6 md:p-10 mt-4 rounded-3xl relative overflow-hidden">
                
                <div class="relative z-10 text-center">
                    

<div class="p-6 sm:p-10 rounded-3xl bg-gradient-to-br from-indigo-600 to-blue-800 text-white shadow-2xl mb-10 hero-card">
                        <svg class="w-16 h-16 mx-auto mb-4 text-indigo-200 animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c1.657 0 3 .895 3 2s-1.343 2-3 2-3-.895-3-2 1.343-2 3-2zM9 14h6m-6 2h6m-3-10a9 9 0 019 9c0 5.483-4.5 9.98-9 9.98S3 17.483 3 12a9 9 0 019-9z"></path></svg>
                        <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight mb-3">
                            AI-Powered Pet Health Intelligence
                        </h1>
                        <p class="text-lg font-light text-indigo-200">
                            Check local disease risks or analyze photos for potential conditions—instant, actionable insights for your companion.
                        </p>
                    </div>
                    
                    

<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-10">
                        
                        

<div class="p-6 bg-blue-50 border border-blue-200 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
                            <svg class="w-8 h-8 text-blue-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0zM15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            <h2 class="text-xl font-bold text-gray-800 mb-2">Local Risk Scanner</h2>
                            <p class="text-gray-600 text-sm mb-4">Check for active parasitic threats and disease outbreaks based on your city or area.</p>
                            <button onclick="showPage('scanner-page')" class="btn-primary w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-xl text-sm">
                                Go to Scanner
                            </button>
                        </div>
                        
                        

<div class="p-6 bg-blue-50 border border-blue-200 rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">
                            <svg class="w-8 h-8 text-blue-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.218A2 2 0 0110.424 4h3.152a2 2 0 011.664.89l.812 1.218A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            <h2 class="text-xl font-bold text-gray-800 mb-2">Photo Diagnostics</h2>
                            <p class="text-gray-600 text-sm mb-4">Upload an image (e.g., a skin condition, injury) for an AI-powered preliminary assessment.</p>
                            <button onclick="showPage('upload-page')" class="btn-primary w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-xl text-sm">
                                Upload Photo
                            </button>
                        </div>
                    </div>

                    

<p class="text-sm text-gray-500 mt-6 pt-4 border-t border-gray-100 italic">
                        PetScan Pro provides informative assistance and is not a substitute for professional veterinary care. Always consult a veterinarian for health decisions.
                    </p>
                </div>
            </div>

            

<div id="scanner-page" class="container-card w-full bg-white p-6 md:p-10 mt-4 rounded-3xl hidden opacity-0">
                <h1 class="text-3xl font-extrabold text-center text-blue-700 mb-2">City/Area Risk Assessment</h1>
                <p class="text-center text-sm text-gray-500 mb-8">
                    Enter your location and animal type to get a personalized report.
                </p>

                

<div class="space-y-6">
                    <div>
                        <label for="locationInput" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                            <svg class="w-4 h-4 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            City/Area Name
                        </label>
                        <input type="text" id="locationInput" placeholder="e.g., London, UK or Bengaluru, IN" class="input-box w-full p-3 border border-gray-300 rounded-xl bg-gray-50" value="Tambaram">
                    </div>

                    <div>
                        <label for="animalInput" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                            <svg class="w-4 h-4 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5V3m0 18v-2m-7-6H3m18 0h-2M5.636 5.636l1.414 1.414M16.95 16.95l1.414 1.414M6.343 17.657l-1.414-1.414M17.657 6.343l-1.414-1.414"></path></svg>
                            Animal Type
                        </label>
                        <div class="relative">
                            <select id="animalInput" class="input-box w-full p-3 border border-gray-300 rounded-xl bg-gray-50">
                                <option value="cat">Cat</option>
                                <option value="dog">Dog</option>
                                <option value="rabbit">Rabbit</option>
                                <option value="horse">Horse</option>
                            </select>
                        </div>
                    </div>

                    <button id="checkButton" onclick="getDiseaseRiskFromForm()" class="btn-check w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg flex items-center justify-center">
                        Check Disease Risk
                    </button>
                </div>

                

<div id="results" class="mt-10 pt-6 border-t border-blue-100">
                    

<p class="text-center text-gray-500 italic p-4">Enter your details and click 'Check Risk' to generate a report.</p>
                </div>
            </div>

            

<div id="upload-page" class="container-card w-full bg-white p-6 md:p-10 mt-4 rounded-3xl hidden opacity-0">
                <h1 class="text-3xl font-extrabold text-center text-blue-700 mb-2">Photo Analysis</h1>
                <p class="text-center text-sm text-gray-500 mb-8">
                    Upload an image for an AI assessment of potential conditions.
                </p>

                <div class="space-y-6">
                    <div>
                        <label for="imageUpload" class="block text-sm font-medium text-gray-700 mb-1 flex items-center">
                            <svg class="w-4 h-4 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                            Select Image File
                        </label>
                        <input type="file" id="imageUpload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                    </div>

                    

<div id="imagePreviewContainer" class="p-4">
                        <img id="imagePreview" src="" alt="Image Preview" class="hidden">
                        <p id="imagePlaceholder" class="text-gray-400">Preview will appear here</p>
                    </div>

                    <button id="analyzeButton" onclick="analyzeImageForDisease()" class="btn-check w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl shadow-lg flex items-center justify-center" disabled>
                        Analyze Photo for Condition
                    </button>
                </div>

                

<div id="analysisResults" class="mt-10 pt-6 border-t border-blue-100">
                    

<p class="text-center text-gray-500 italic p-4">Upload an image (e.g., skin rash, paw injury, visible symptom) and click 'Analyze'.</p>
                </div>
            </div>


            

<div id="about-us-page" class="container-card w-full bg-white p-8 md:p-12 mt-4 rounded-3xl hidden opacity-0">
                <h2 class="text-3xl font-extrabold text-center text-indigo-700 mb-8">Our Mission: Proactive Pet Health</h2>
                
                <div class="space-y-6 text-gray-700">
                    <p class="text-lg leading-relaxed">
                        At **PetScan Pro**, we believe that informed pet owners are the best pet owners. We created this tool to bridge the gap between complex veterinary public health data and the everyday needs of pet families. Our system leverages advanced AI and real-time data integration to deliver localized, actionable risk assessments.
                    </p>
                    <div class="border-l-4 border-indigo-400 pl-4 py-2 bg-indigo-50 rounded-r-lg">
                        <p class="font-semibold text-indigo-800 italic">
                            "Our goal is to eliminate uncertainty and provide the confidence needed to ensure the well-being of your beloved animals."
                        </p>
                    </div>
                    <h3 class="text-xl font-bold pt-4 text-blue-600">How It Works</h3>
                    <p>
                        We utilize Google Search grounding to scan reputable sources, including government reports, university veterinary journals, and local health alerts, specifically focusing on the geographic region and animal type you provide. For the **File Upload** feature, we use multimodal AI to analyze the visual information in your photo against known veterinary conditions, offering a preliminary diagnostic hypothesis.
                    </p>
                    <h3 class="text-xl font-bold pt-4 text-blue-600">The Team</h3>
                    <p>
                        We are a small team of data scientists, veterinarians, and software developers passionate about animal welfare. This platform is continuously updated and refined based on the latest advancements in veterinary science and technology.
                    </p>
                </div>
            </div>
            
        </div>
    </main>

    

<footer class="bg-gray-800 text-white mt-12 py-8">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center md:flex md:justify-between md:items-center">
            <div class="mb-4 md:mb-0">
                <h4 class="text-xl font-semibold">PetScan Pro</h4>
                <p class="text-sm text-gray-400">Local Health Intelligence for your Pets</p>
            </div>
            <div class="flex justify-center space-x-6">
                <a href="#" class="text-gray-400 hover:text-white transition-colors text-sm">Privacy Policy</a>
                <a href="#" class="text-gray-400 hover:text-white transition-colors text-sm">Terms of Service</a>
                <button onclick="showPage('about-us-page')" class="text-gray-400 hover:text-white transition-colors text-sm">Contact</button>
            </div>
            <div class="mt-4 md:mt-0 text-gray-500 text-sm">
                &copy; 2024 PetScan Pro. All rights reserved.
            </div>
        </div>
    </footer>

    <script>
        // --- 1. State and UI Control ---
        const ALL_PAGES = ['home-page', 'scanner-page', 'upload-page', 'about-us-page']; 

        document.addEventListener('DOMContentLoaded', () => {
            showPage('home-page');
            document.getElementById('imageUpload').addEventListener('change', previewImage);
        });

        /**
         * Simple single-page routing logic with a fade transition and active link highlighting.
         * Explicitly attach to window to ensure accessibility from inline onclick handlers.
         */
        window.showPage = function(pageId) {
            ALL_PAGES.forEach(id => {
                const page = document.getElementById(id);
                const navLink = document.getElementById(`nav-${id}`);

                if (page) {
                    if (id === pageId) {
                        page.classList.remove('hidden');
                        setTimeout(() => {
                            page.classList.remove('opacity-0');
                            page.classList.add('opacity-100');
                        }, 10);
                    } else {
                        page.classList.remove('opacity-100');
                        page.classList.add('opacity-0');
                        setTimeout(() => {
                            page.classList.add('hidden');
                        }, 500);
                    }
                }
                
                // Active link highlighting
                if (navLink) {
                    navLink.classList.toggle('active', id === pageId);
                }
            });
        }

        /**
         * Toggles the visibility of the treatment and prevention details.
         */
        window.toggleDetails = function(elementId) {
            const content = document.getElementById(elementId);
            const button = content.previousElementSibling.querySelector('svg');
            
            content.classList.toggle('open');
            content.classList.toggle('hidden');
            
            if (button) {
                button.classList.toggle('rotate-180');
            }
        }
        
        // Helper function to display messages to the user.
        function displayMessage(element, message, classString) {
            element.innerHTML = `<p class="p-4 text-center rounded-xl border ${classString} font-medium">${message}</p>`;
        }

        // --- 2. Gemini API Configuration ---
        const apiKey = "AIzaSyDXnxB5iafTlL4aXRf-8miti7Lrd1aKahE"; // API key is automatically provided in this environment
        const apiUrl = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent';

        /**
         * Generic fetch utility with exponential backoff for resilience.
         */
        async function fetchWithExponentialBackoff(url, options, maxRetries = 3) {
            for (let attempt = 0; attempt < maxRetries; attempt++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (attempt === maxRetries - 1) {
                        console.error('API call failed after all retries:', error);
                        throw new Error('Could not connect to the external data service. Please try again later.');
                    }
                    const delay = Math.pow(2, attempt) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // --- 3. Scanner Page Functions (Updated) ---
        
        /**
         * Determines the color and label for the risk badge.
         */
        function getRiskDetails(risk) {
            const upperRisk = risk.toUpperCase();
            if (upperRisk.includes('HIGH')) {
                return { label: 'HIGH RISK', color: 'bg-red-500', icon: '🚨' };
            }
            if (upperRisk.includes('MEDIUM')) {
                return { label: 'MEDIUM RISK', color: 'bg-yellow-500', icon: '⚠️' };
            }
            return { label: 'LOW RISK', color: 'bg-green-500', icon: '✅' };
        }
        
        /**
         * Parses the detailed body into structured disease objects, now extracting Treatment & Prevention.
         */
        function parseReportBody(reportBody) {
            // Split into disease paragraphs, looking for double newlines
            const paragraphs = reportBody.split(/\n{2,}|\<br\>\<br\>/).map(p => p.trim()).filter(p => p.length > 0);
            const diseases = [];
            const separator = "Treatment & Prevention:"; // The key phrase added to the prompt

            paragraphs.forEach(p => {
                let description = p;
                let treatment = "Consult your veterinarian immediately for specific advice.";
                
                // 1. Try to split the paragraph into description and treatment
                const treatmentIndex = p.indexOf(separator);
                if (treatmentIndex !== -1) {
                    // Separate the text at the defined separator
                    description = p.substring(0, treatmentIndex).trim();
                    treatment = p.substring(treatmentIndex + separator.length).trim();
                }

                // 2. Extract Disease Name and Risk Level from the description part
                const matchName = description.match(/^([A-Za-z0-9\s-,\/]+) is noted/i) || description.match(/^(?:Disease: )?([A-Za-z0-9\s-,\/]+)[:.]/i) || description.match(/^([A-Za-z0-9\s-,\/]+) \((?:High|Medium|Low) Risk\)/i);
                const matchRisk = description.match(/(High|Medium|Low) Risk/i);

                let diseaseName = matchName ? matchName[1].trim() : 'Unknown Disease';
                const riskLevel = matchRisk ? matchRisk[1] : 'Unknown';

                // Simple cleanup of the name if it includes the risk level
                if (diseaseName.includes(riskLevel)) {
                    diseaseName = diseaseName.substring(0, diseaseName.indexOf(riskLevel)).trim().replace(/[,.:]$/, '');
                }
                
                // Clean up description further
                description = description.replace(/^(?:Disease: )?/, '').trim();


                diseases.push({ diseaseName, riskLevel, description, treatment });
            });

            return diseases;
        }


        /**
         * Fetches disease data using Gemini API with Google Search grounding.
         */
        async function getDiseaseRisk(animal, location, resultsDivId) {
            const resultsDiv = document.getElementById(resultsDivId);
            const checkButton = document.getElementById('checkButton');

            // Set up button/loading state
            checkButton.disabled = true;
            checkButton.innerHTML = '<span class="spinner"></span> Generating In-Depth Report...';
            
            // Clear old results and show loading
             resultsDiv.innerHTML = `<p class="p-4 text-center rounded-xl border bg-blue-50 text-blue-700 border-blue-300 font-medium flex items-center justify-center">
                                            <span class="spinner"></span>
                                            <span class="ml-2">Scanning Location: ${location}...</span>
                                        </p>`;

            try {
                const systemPrompt = `You are a specialized Veterinary Public Health Analyst. Your task is to provide an overall summary risk level (High, Medium, or Low) in the first sentence of your response, followed by a detailed, factual summary of the top 3-5 high-risk and most prevalent diseases (viral, bacterial, parasitic) affecting ${animal} in the specific region of ${location}. Base your findings ONLY on current public health reports, government veterinary databases, and major, reputable local veterinary news sources found via search. 
                                    
                                    Format the report strictly:
                                    1. Start with the overall risk sentence: 'The overall disease risk for a ${animal} in ${location} is [HIGH/MEDIUM/LOW] due to [brief reason].'
                                    2. After the first sentence, create a separate, concise paragraph for each disease.
                                    3. Each disease paragraph MUST contain the following information, in order: Disease Name, Risk Level (High, Medium, Low), a brief description of local prevalence and symptoms.
                                    4. Crucially, each disease paragraph MUST end with the specific phrase "Treatment & Prevention:" followed immediately by detailed advice on veterinary treatment (cure) and prevention steps for a ${animal}.
                                    5. Separate these disease paragraphs with a double line break (\\n\\n). Do NOT use markdown headings, bullet points, or tables.`;
                
                const userQuery = `Summarize the major current animal disease risks, including treatment and prevention advice, for ${animal} in ${location}.`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    tools: [{ "google_search": {} }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                const urlWithKey = `${apiUrl}?key=${apiKey}`;

                const options = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                };

                // 2. Fetch Data
                const result = await fetchWithExponentialBackoff(urlWithKey, options);
                const responseJson = await result.json(); 
                
                const candidate = responseJson.candidates?.[0];

                if (!candidate || !candidate.content?.parts?.[0]?.text) {
                     throw new Error("The risk checker could not generate a valid report. The search may have returned no local data.");
                }

                const fullText = candidate.content.parts[0].text;
                let sources = [];
                const groundingMetadata = candidate.groundingMetadata;

                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);
                }
                
                // 3. Extract Risk Level and Report Body
                const overallRiskSentenceMatch = fullText.match(/The overall disease risk for a (.*) is (?:HIGH|MEDIUM|LOW) due to (.*)\./i);
                
                let overallRiskSentence = overallRiskSentenceMatch ? overallRiskSentenceMatch[0] : "The overall disease risk assessment is inconclusive, but potential threats are listed below.";
                
                // Remove the overall sentence from the body for parsing
                let reportBody = fullText.replace(overallRiskSentence, '').trim();
                
                const { label, color, icon } = getRiskDetails(overallRiskSentence);
                const diseases = parseReportBody(reportBody);

                // 4. Display Results
                let resultsHTML = `
                    <div class="flex flex-col sm:flex-row items-center justify-between mb-6 border-b pb-2 border-blue-200">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-2 sm:mb-0">
                            <span class="text-blue-600">Report:</span> ${animal} in ${location}
                        </h2>
                        <span class="px-5 py-2 text-md font-bold text-white rounded-full ${color} shadow-lg transform hover:scale-105 transition-transform duration-200">
                            ${icon} ${label}
                        </span>
                    </div>
                `;
                
                // Display Generated Text (Overall Summary)
                resultsHTML += `<div class="p-4 bg-blue-50 border border-blue-300 rounded-xl shadow-inner mb-6 text-gray-800 font-medium text-lg leading-relaxed">
                                    <p class="font-bold text-blue-800 mb-2">Overall Assessment:</p>
                                    <p>${overallRiskSentence}</p>
                                </div>`;

                // Display Detailed Disease Cards
                if (diseases.length > 0) {
                     resultsHTML += `<h3 class="text-xl font-extrabold text-gray-800 mb-4 border-b pb-2">Top Disease Threats:</h3>`;
                     diseases.forEach((d, index) => {
                        const { label: dLabel, color: dColor } = getRiskDetails(d.riskLevel);
                        const collapseId = `${resultsDivId}-details-${index}`;

                        resultsHTML += `
                            <div class="mb-4 border border-gray-200 rounded-xl shadow-md bg-white overflow-hidden">
                                <div class="p-4">
                                    <div class="flex justify-between items-start mb-2">
                                        <h4 class="text-lg font-bold text-gray-800">${d.diseaseName}</h4>
                                        <span class="text-xs font-semibold px-3 py-1 rounded-full text-white ${dColor}">${dLabel}</span>
                                    </div>
                                    <p class="text-gray-600 text-sm leading-relaxed">${d.description.replace('Treatment & Prevention:', '')}</p>
                                </div>

                                

<button onclick="toggleDetails('${collapseId}')" class="flex justify-between items-center w-full p-4 bg-gray-50 hover:bg-gray-100 transition-colors duration-200 border-t border-gray-200">
                                    <span class="text-base font-semibold text-blue-700">Recommended Action (Cure & Prevention)</span>
                                    <svg class="w-5 h-5 text-blue-600 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                                
                                

<div id="${collapseId}" class="collapsible-content hidden p-4 pt-0 bg-white border-t border-gray-100">
                                    <div class="text-gray-700 text-sm leading-relaxed">
                                        <p class="font-bold mb-1 text-gray-800">Veterinary Advice:</p>
                                        ${d.treatment.split('\n').map(line => `<p class="mb-2">${line.trim()}</p>`).join('')}
                                    </div>
                                    <p class="mt-4 text-xs italic text-gray-400">Disclaimer: This advice is informative. ALWAYS consult a licensed veterinarian for diagnosis and treatment.</p>
                                </div>
                            </div>
                        `;
                    });
                }


                // Display Sources
                if (sources.length > 0) {
                    resultsHTML += `<h3 class="text-md font-semibold text-gray-600 mt-8 mb-3 border-b border-gray-100 pb-1">Sources Referenced:</h3>`;
                    resultsHTML += `<ul class="list-disc list-outside text-sm text-gray-600 space-y-2 p-4 bg-gray-100 rounded-xl shadow-inner">`;
                    sources.slice(0, 5).forEach((source) => {
                        resultsHTML += `<li class="ml-4"><a href="${source.uri}" target="_blank" class="text-blue-600 hover:text-blue-800 font-medium break-words">${source.title}</a></li>`;
                    });
                    resultsHTML += `</ul>`;
                } else {
                    resultsHTML += `<p class="text-sm text-gray-400 italic mt-8 p-3 bg-gray-50 rounded-lg">No specific web sources were cited for this report. The summary relies on general knowledge base.</p>`;
                }
                
                resultsDiv.innerHTML = resultsHTML;

            } catch (error) {
                console.error("Error in getDiseaseRisk:", error);
                const errorMessage = error.message.includes('Could not connect') 
                    ? error.message 
                    : "An unexpected error occurred while fetching data. Please refine your search and try again.";
                displayMessage(resultsDiv, `🚨 Error: ${errorMessage}`, 'bg-red-100 text-red-700 border-red-300');
            } finally {
                // Restore Button State for Scanner Page
                checkButton.disabled = false;
                checkButton.innerHTML = 'Check Disease Risk';
            }
        }

        /**
         * Main function to handle user interaction from the manual form.
         * Explicitly attach to window to ensure accessibility from inline onclick handlers.
         */
        window.getDiseaseRiskFromForm = async function() {
            const locationInput = document.getElementById('locationInput').value.trim();
            const animalInput = document.getElementById('animalInput').value.trim();
            const resultsDiv = document.getElementById('results');
            
            resultsDiv.innerHTML = '';
            
            if (!locationInput || !animalInput) {
                displayMessage(resultsDiv, "Please enter a valid city/area and select an animal.", 'bg-red-100 text-red-700 border-red-300');
                return;
            }
            
            await getDiseaseRisk(animalInput, locationInput, 'results');
        }
        
        // --- 4. File Upload Page Functions (NEW) ---

        let base64Image = null;
        let mimeType = null;

        /**
         * Converts a File object to a Base64 string.
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = error => reject(error);
            });
        }

        /**
         * Handles image preview and stores base64 for API call.
         */
        async function previewImage(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('imagePreview');
            const placeholder = document.getElementById('imagePlaceholder');
            const analyzeButton = document.getElementById('analyzeButton');
            const analysisResults = document.getElementById('analysisResults');

            analysisResults.innerHTML = ''; // Clear old results

            if (file) {
                try {
                    // Update preview
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        preview.src = e.target.result;
                        preview.classList.remove('hidden');
                        placeholder.classList.add('hidden');
                    };
                    reader.readAsDataURL(file);

                    // Store data for API call
                    base64Image = await fileToBase64(file);
                    mimeType = file.type;
                    analyzeButton.disabled = false;
                    // Changed message background to blue
                    displayMessage(analysisResults, `File ready for analysis: ${file.name}. Click 'Analyze Photo'.`, 'bg-blue-50 text-blue-700 border-blue-300');

                } catch (error) { // FIX: Removed unexpected `< /div>` before catch
                    console.error("Error reading file:", error);
                    base64Image = null;
                    mimeType = null;
                    analyzeButton.disabled = true;
                    displayMessage(analysisResults, 'Error processing file. Please try a different image.', 'bg-red-100 text-red-700 border-red-300');
                }
            } else {
                preview.classList.add('hidden');
                placeholder.classList.remove('hidden');
                analyzeButton.disabled = true;
                base64Image = null;
                mimeType = null;
            }
        }

        /**
         * Calls the Gemini API to analyze the uploaded image for disease/condition.
         * Explicitly attach to window to ensure accessibility from inline onclick handlers.
         */
        window.analyzeImageForDisease = async function() {
            if (!base64Image || !mimeType) {
                displayMessage(document.getElementById('analysisResults'), 'Please upload an image first.', 'bg-red-100 text-red-700 border-red-300');
                return;
            }

            const resultsDiv = document.getElementById('analysisResults');
            const analyzeButton = document.getElementById('analyzeButton');
            
            // Set loading state (Message color changed to blue)
            analyzeButton.disabled = true;
            analyzeButton.innerHTML = '<span class="spinner"></span> Analyzing Image...';
            resultsDiv.innerHTML = `<p class="p-4 text-center rounded-xl border bg-blue-50 text-blue-700 border-blue-300 font-medium flex items-center justify-center">
                                        <span class="spinner"></span>
                                        <span class="ml-2">Uploading image for veterinary assessment...</span>
                                    </p>`;

            try {
                const imageSystemPrompt = `You are a highly specialized Veterinary Image Diagnostics AI, expertly trained to identify potential animal health conditions from visual input. Your analysis should be thorough and clinically relevant, providing a *hypothetical* diagnosis and actionable advice.

                                            Format your response strictly as follows:

                                            **Disclaimer: This is an AI-generated hypothetical assessment, NOT a professional veterinary diagnosis. Always consult a licensed veterinarian for definitive diagnosis and treatment.**

                                            ---

                                            **Image Analysis Report**

                                            **Observed Visual Cues:** [List specific, objective observations from the image that are relevant to potential conditions, e.g., 'Patches of inflamed red skin on the abdomen,' 'Swelling around the left eye,' 'Hair loss and scaling on the ears.']

                                            **Potential Conditions (Top 3-5 Hypotheses):**

                                            1.  **[Condition Name 1]:**
                                                * **Likely Indication:** [Explain *why* this condition is suggested by the visual cues, linking symptoms directly to the disease. Be concise but informative.]
                                                * **Recommended Urgent Action:** [Provide clear, immediate, practical steps an owner should take *before* a vet visit to manage the condition, ensure comfort, or prevent worsening. E.g., 'Gently clean the affected area with warm water,' 'Prevent the animal from scratching/licking using a cone,' 'Monitor for fever.']

                                            2.  **[Condition Name 2]:**
                                                * **Likely Indication:** [Explain *why* this condition is suggested by the visual cues.]
                                                * **Recommended Urgent Action:** [Provide clear, immediate, practical steps.]

                                            3.  **[Condition Name 3]:**
                                                * **Likely Indication:** [Explain *why* this condition is suggested by the visual cues.]
                                                * **Recommended Urgent Action:** [Provide clear, immediate, practical steps.]
                                            
                                            [Add more conditions if visually strongly indicated, up to 5.]

                                            ---

                                            **General Advice:** Ensure the animal has access to fresh water and a quiet, comfortable resting place. Document any changes in symptoms or behavior to share with your veterinarian. Do not administer any medications without veterinary guidance.`;

                const userPrompt = "Analyze this animal image. What potential disease, injury, or skin condition is visible? Provide likely hypotheses and immediate action steps based on the visual evidence. Focus only on what is observable in the image.";

                const payload = {
                    contents: [
                        {
                            role: "user",
                            parts: [
                                { text: userPrompt },
                                {
                                    inlineData: {
                                        mimeType: mimeType,
                                        data: base64Image
                                    }
                                }
                            ]
                        }
                    ],
                    systemInstruction: { parts: [{ text: imageSystemPrompt }] },
                };

                const urlWithKey = `${apiUrl}?key=${apiKey}`;

                const options = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                };

                // 1. Fetch Data
                const result = await fetchWithExponentialBackoff(urlWithKey, options);
                const responseJson = await result.json(); 
                
                const responseText = responseJson.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!responseText) {
                    throw new Error("Could not process the image or no clear health condition was detected.");
                }

                // 2. Format Results (Simple Markdown rendering of the structured text)
                resultsDiv.innerHTML = `<div class="p-6 bg-white border border-gray-200 rounded-xl shadow-lg leading-relaxed text-gray-700">
                                            ${marked.parse(responseText)}
                                        </div>
                                        <p class="text-sm text-gray-500 mt-4 text-center italic">
                                            For best results, upload a clear, well-lit photo focusing on the area of concern.
                                        </p>`;

            } catch (error) {
                console.error("Error in analyzeImageForDisease:", error);
                const errorMessage = error.message.includes('Could not process') 
                    ? error.message 
                    : "An unexpected error occurred during analysis. Please check the file type (PNG/JPEG) and try again.";
                displayMessage(resultsDiv, `🚨 ${errorMessage}`, 'bg-red-100 text-red-700 border-red-300');
            } finally {
                // Restore Button State
                analyzeButton.disabled = false;
                analyzeButton.innerHTML = 'Analyze Photo for Condition';
            }
        }
    </script>
    

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</body>
</html>
